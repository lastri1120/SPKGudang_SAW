<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>SPK Gudang - Metode SAW</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
  <style>
    .section { display: none; }
    .section.active { display: block; }
    .menu.active { background-color: #a855f7; }
  </style>
</head>
<body class="flex min-h-screen bg-gray-100">

<div id="overlay" class="fixed inset-0 bg-black bg-opacity-40 z-50 hidden"></div>

<aside class="w-64 bg-purple-800 text-white flex flex-col">
  <div class="p-6 font-bold text-xl">SPK Gudang<br><span class="text-sm">Metode SAW</span></div>
  <nav class="flex-1 space-y-1 px-4">
    <button class="menu active w-full text-left px-4 py-2 rounded" onclick="showSection('dashboard')" id="nav-dashboard">Dashboard</button>
    <button class="menu w-full text-left px-4 py-2 rounded" onclick="showSection('penjualan')" id="nav-penjualan">Data Penjualan</button>
    <button class="menu w-full text-left px-4 py-2 rounded" onclick="showSection('cabang')" id="nav-cabang">Data Cabang</button>
    <button class="menu w-full text-left px-4 py-2 rounded" onclick="showSection('kriteria')" id="nav-kriteria">Kriteria & Bobot</button>
    <button class="menu w-full text-left px-4 py-2 rounded" onclick="showSection('hasil')" id="nav-hasil">Hasil SAW</button>
  </nav>
</aside>

<main class="flex-1 p-8">

<section id="dashboard" class="section active">
  <h1 class="text-2xl font-bold mb-6">Dashboard SPK Gudang</h1>
  <div class="grid grid-cols-4 gap-4 mb-6">
    <div class="bg-white rounded shadow p-4 text-center">
      <h5 class="font-bold text-lg">Total Cabang</h5>
      <p id="totalCabang" class="text-2xl text-purple-600">0</p>
    </div>
    <div class="bg-white rounded shadow p-4 text-center">
      <h5 class="font-bold text-lg">Total Penjualan</h5>
      <p id="totalPenjualan" class="text-2xl text-purple-600">0</p>
    </div>
    <div class="bg-white rounded shadow p-4 text-center">
      <h5 class="font-bold text-lg">Total Kriteria</h5>
      <p id="totalKriteria" class="text-2xl text-purple-600">0</p>
    </div>
  </div>

  <button onclick="runHitungSAW('dashboard')" class="bg-purple-600 text-white px-4 py-2 rounded mb-4">Mulai Hitung SAW</button>

  <table class="w-full bg-white rounded shadow border text-sm mt-4">
    <thead class="bg-purple-200">
      <tr>
        <th class="p-2">Ranking</th>
        <th class="p-2">Cabang</th>
        <th class="p-2">Nilai</th>
      </tr>
    </thead>
    <tbody id="dashboard-ranking-body"></tbody>
  </table>
</section>

<section id="penjualan" class="section">
  <div class="flex justify-between items-center mb-4">
    <h1 class="text-2xl font-bold">Data Penjualan</h1>
    <button onclick="showPenjualanForm()" class="bg-blue-600 text-white px-4 py-2 rounded">+ Tambah Data</button>
  </div>
  <div id="penjualan-list" class="bg-white rounded shadow p-4">
    <table class="w-full border text-sm">
      <thead class="bg-purple-600 text-white">
        <tr>
          <th class="p-2">No</th>
          <th class="p-2">Cabang</th>
          <th class="p-2">Produk</th>
          <th class="p-2">Jumlah</th>
          <th class="p-2">Aksi</th>
        </tr>
      </thead>
      <tbody id="listPenjualan">
        <tr><td colspan="5" class="text-center p-4 text-gray-400">Memuat data...</td></tr>
      </tbody>
    </table>
  </div>

  <div id="penjualan-form" class="hidden bg-white rounded shadow p-6">
    <div class="flex justify-between mb-4">
      <h3 class="text-lg font-bold">Form Penjualan</h3>
      <button onclick="showPenjualanList()" class="bg-gray-500 text-white px-3 py-1 rounded">‚Üê Kembali</button>
    </div>
    <div class="grid grid-cols-2 gap-4">
      <div>
        <label>Cabang</label>
        <select id="cabangJual" class="w-full border p-2 rounded"></select>
      </div>
      <div>
        <label>Produk</label>
        <input id="produkJual" class="w-full border p-2 rounded">
      </div>
      <div>
        <label>Jumlah Terjual</label>
        <input type="number" id="jumlahJual" class="w-full border p-2 rounded">
      </div>
    </div>
    <div class="mt-6 flex justify-end gap-2">
      <button onclick="tambahPenjualan()" class="bg-blue-600 text-white px-6 py-2 rounded">Simpan</button>
    </div>
  </div>
</section>

<section id="cabang" class="section">
    <h1 class="text-2xl font-bold mb-4">Data Cabang</h1>
    <button onclick="showFormCabang()" class="bg-green-600 text-white px-4 py-2 rounded mb-3">Tambah Cabang</button>
    <table class="w-full bg-white rounded shadow text-sm border">
        <thead class="bg-purple-600 text-white">
            <tr>
                <th class="p-2">No</th>
                <th class="p-2">Kode</th>
                <th class="p-2">Nama</th>
                <th class="p-2">Alamat</th>
                <th class="p-2">Aksi</th>
            </tr>
        </thead>
        <tbody id="tblCabang"></tbody>
    </table>
</section>

<section id="kriteria" class="section">
    <h1 class="text-2xl font-bold mb-4">Data Kriteria</h1>
    <table class="w-full bg-white rounded shadow text-sm border">
        <thead class="bg-blue-600 text-white">
            <tr>
                <th class="p-2">No</th>
                <th class="p-2">Kode</th>
                <th class="p-2">Nama</th>
                <th class="p-2">Tipe</th>
                <th class="p-2">Bobot</th>
                <th class="p-2">Aksi</th>
            </tr>
        </thead>
        <tbody id="tblKriteria"></tbody>
    </table>
</section>

<section id="hasil" class="section">
    <h1 class="text-2xl font-bold mb-4">Hasil SAW</h1>
    <button onclick="runHitungSAW('hasil')" class="bg-purple-600 text-white px-4 py-2 rounded mb-4">Hitung Ulang</button>
    <table class="w-full bg-white rounded shadow border text-sm">
        <thead class="bg-purple-200">
            <tr>
                <th class="p-2">Ranking</th>
                <th class="p-2">Cabang</th>
                <th class="p-2">Nilai</th>
            </tr>
        </thead>
        <tbody id="hasil-ranking-body"></tbody>
    </table>
</section>

</main>

<script>
// ===== KONFIGURASI API (MENGGUNAKAN RELATIVE URL) =====
const API_CABANG = "/api/cabang";
const API_PENJUALAN = "/api/penjualan";
const API_KRITERIA = "/api/kriteria";
const API_SAW = "/api/saw";

// ===== NAVIGASI =====
function showSection(id){
  document.querySelectorAll(".section").forEach(sec => sec.classList.remove("active"));
  document.querySelectorAll(".menu").forEach(menu => menu.classList.remove("active"));
  document.getElementById(id).classList.add("active");
  const nav = document.getElementById("nav-" + id);
  if(nav) nav.classList.add("active");
}

// ===== LOAD DASHBOARD =====
async function loadDashboard() {
  try {
    const cabang = await fetch(API_CABANG).then(r => r.json());
    document.getElementById("totalCabang").innerText = cabang.length || 0;

    const penjualan = await fetch(API_PENJUALAN).then(r => r.json());
    document.getElementById("totalPenjualan").innerText = penjualan.length || 0;

    const kriteria = await fetch(API_KRITERIA).then(r => r.json());
    document.getElementById("totalKriteria").innerText = kriteria.length || 0;

    loadRanking("dashboard");
  } catch (err) { console.error("Error Dashboard:", err); }
}

// ===== LOAD DATA CABANG =====
async function loadCabang(){
  try {
    const res = await fetch(API_CABANG);
    const data = await res.json();
    const select = document.getElementById("cabangJual");
    select.innerHTML = `<option value="">-- Pilih Cabang --</option>`;
    data.forEach(c => select.innerHTML += `<option value="${c.id}">${c.nama_cabang}</option>`);

    const tbody = document.getElementById("tblCabang");
    tbody.innerHTML = "";
    data.forEach((c,i)=>{
        tbody.innerHTML += `<tr>
            <td class="border p-2">${i+1}</td>
            <td class="border p-2">${c.kode_cabang}</td>
            <td class="border p-2">${c.nama_cabang}</td>
            <td class="border p-2">${c.alamat}</td>
            <td class="border p-2 text-center">
                <button onclick="hapusCabang(${c.id})" class="bg-red-600 text-white px-2 py-1 rounded text-xs">Hapus</button>
            </td>
        </tr>`;
    });
  } catch(err) { console.error(err); }
}

// ===== LOAD DATA PENJUALAN =====
async function loadPenjualan(){
  try {
    const res = await fetch(API_PENJUALAN);
    const data = await res.json();
    const tbody = document.getElementById("listPenjualan");
    tbody.innerHTML="";
    data.forEach((p,i)=>{
      tbody.innerHTML += `<tr>
        <td class="border p-2">${i+1}</td>
        <td class="border p-2">${p.nama_cabang}</td>
        <td class="border p-2">${p.produk}</td>
        <td class="border p-2">${p.jumlah}</td>
        <td class="border p-2 text-center">
          <button onclick="hapusPenjualan(${p.id})" class="bg-red-600 text-white px-2 py-1 rounded text-xs">Hapus</button>
        </td>
      </tr>`;
    });
  } catch(err) { console.error(err); }
}

// ===== HITUNG SAW =====
async function runHitungSAW(target) {
  try {
    const res = await fetch(`${API_SAW}/hitung`, { method: "POST" });
    const data = await res.json();
    
    // Simpan hasil ke DB
    await fetch(`${API_SAW}/simpan`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ hasil: data.hasil })
    });

    alert("Perhitungan Selesai!");
    loadRanking(target);
  } catch (err) { alert("Gagal hitung!"); }
}

async function loadRanking(target){
  try {
    const res = await fetch(`${API_SAW}/ranking`);
    const saw = await res.json();
    const tbodyId = target === "dashboard" ? "dashboard-ranking-body" : "hasil-ranking-body";
    const tbody = document.getElementById(tbodyId);
    tbody.innerHTML = "";

    if(!saw.success || !saw.hasil.length) {
        tbody.innerHTML = `<tr><td colspan="3" class="text-center p-4">Belum ada data</td></tr>`;
        return;
    }

    saw.hasil.forEach(r => {
      tbody.innerHTML += `<tr>
        <td class="border p-2 text-center">${r.ranking}</td>
        <td class="border p-2">${r.nama_cabang}</td>
        <td class="border p-2 text-center">${parseFloat(r.nilai).toFixed(4)}</td>
      </tr>`;
    });
  } catch(err) { console.error(err); }
}

// ===== TAMBAH PENJUALAN =====
async function tambahPenjualan(){
  const cabang = document.getElementById("cabangJual").value;
  const produk = document.getElementById("produkJual").value;
  const jumlah = document.getElementById("jumlahJual").value;

  await fetch(API_PENJUALAN, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ cabang_id: cabang, produk, jumlah })
  });
  loadPenjualan();
  showPenjualanList();
}

// ===== UI HELPERS =====
function showPenjualanForm() { document.getElementById("penjualan-list").classList.add("hidden"); document.getElementById("penjualan-form").classList.remove("hidden"); }
function showPenjualanList() { document.getElementById("penjualan-form").classList.add("hidden"); document.getElementById("penjualan-list").classList.remove("hidden"); }

window.onload = () => {
  loadCabang();
  loadPenjualan();
  loadDashboard();
};
</script>
</body>
</html>